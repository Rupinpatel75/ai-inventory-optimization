{% extends 'base.html' %}

{% block head %}
<title>AI Inventory Optimization - Dashboard</title>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark">
            <div class="card-body">
                <h1 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Dashboard
                </h1>
                <p class="card-text">
                    Comprehensive view of your inventory system with AI-powered insights, metrics, and visualizations.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-dark text-center h-100">
            <div class="card-body">
                <h5 class="card-title text-muted">Products</h5>
                <h2 class="card-text" id="products-count">--</h2>
                <i class="fas fa-box fa-2x text-primary"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-center h-100">
            <div class="card-body">
                <h5 class="card-title text-muted">Stores</h5>
                <h2 class="card-text" id="stores-count">--</h2>
                <i class="fas fa-store fa-2x text-success"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-center h-100">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Inventory</h5>
                <h2 class="card-text" id="total-inventory">--</h2>
                <i class="fas fa-boxes fa-2x text-warning"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-center h-100">
            <div class="card-body">
                <h5 class="card-title text-muted">AI Decisions</h5>
                <h2 class="card-text" id="ai-decisions">--</h2>
                <i class="fas fa-robot fa-2x text-info"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark">
            <div class="card-header bg-primary">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 text-white">Inventory Status</h3>
                    <div>
                        <select class="form-select form-select-sm" id="store-filter">
                            <option value="all" selected>All Stores</option>
                            {% for store in stores %}
                            <option value="{{ store.id }}">{{ store.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Store</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                            <tr>
                                <td colspan="6" class="text-center">Loading inventory data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-dark h-100">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">Inventory by Category</h3>
            </div>
            <div class="card-body">
                <canvas id="category-chart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card bg-dark h-100">
            <div class="card-header bg-warning text-dark">
                <h3 class="mb-0">Inventory by Store</h3>
            </div>
            <div class="card-body">
                <canvas id="store-chart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">Recent AI Agent Activities</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Agent</th>
                                <th>Action</th>
                                <th>Product</th>
                                <th>Store</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="agent-logs-body">
                            <tr>
                                <td colspan="6" class="text-center">Loading agent activities...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <a href="/logs" class="btn btn-outline-info btn-sm">View All Logs</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart_utils.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    let categoryChart = null;
    let storeChart = null;
    
    // Load initial data
    loadDashboardData();
    loadInventoryData();
    loadAgentLogs();
    
    // Add event listener for store filter
    document.getElementById('store-filter').addEventListener('change', function() {
        loadInventoryData(this.value);
    });
    
    // Function to load dashboard overview data
    function loadDashboardData() {
        // Load products count
        fetch('/api/products')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('products-count').textContent = data.products.length;
                }
            })
            .catch(error => console.error('Error fetching products:', error));
            
        // Load stores count
        fetch('/api/stores')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('stores-count').textContent = data.stores.length;
                }
            })
            .catch(error => console.error('Error fetching stores:', error));
            
        // Load inventory data
        fetch('/api/inventory')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Calculate total inventory
                    const totalInventory = data.inventory.reduce((total, item) => total + item.quantity, 0);
                    document.getElementById('total-inventory').textContent = totalInventory;
                    
                    // Create category chart
                    createCategoryChart(data.inventory);
                    
                    // Create store chart
                    createStoreChart(data.inventory);
                }
            })
            .catch(error => console.error('Error fetching inventory:', error));
            
        // Load agent logs count
        fetch('/api/logs?limit=1000')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('ai-decisions').textContent = data.logs.length;
                }
            })
            .catch(error => console.error('Error fetching logs:', error));
    }
    
    // Function to load inventory table data
    function loadInventoryData(storeId = 'all') {
        fetch('/api/inventory')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('inventory-table-body');
                    let inventoryData = data.inventory;
                    
                    // Filter by store if needed
                    if (storeId !== 'all') {
                        inventoryData = inventoryData.filter(item => item.store_id == storeId);
                    }
                    
                    // Clear table
                    tableBody.innerHTML = '';
                    
                    if (inventoryData.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No inventory data available</td></tr>';
                        return;
                    }
                    
                    // Add rows
                    inventoryData.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // Calculate inventory status
                        let status = 'Normal';
                        let statusClass = 'bg-success';
                        
                        if (item.quantity <= 10) {
                            status = 'Low';
                            statusClass = 'bg-danger';
                        } else if (item.quantity <= 25) {
                            status = 'Warning';
                            statusClass = 'bg-warning text-dark';
                        } else if (item.quantity >= 80) {
                            status = 'Overstocked';
                            statusClass = 'bg-info';
                        }
                        
                        // Format date
                        const lastUpdated = new Date(item.last_updated);
                        const formattedDate = lastUpdated.toLocaleString();
                        
                        row.innerHTML = `
                            <td>${item.product_name}</td>
                            <td>${getProductCategory(item.product_id)}</td>
                            <td>${item.store_name}</td>
                            <td>${item.quantity}</td>
                            <td><span class="badge ${statusClass}">${status}</span></td>
                            <td>${formattedDate}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching inventory:', error);
                const tableBody = document.getElementById('inventory-table-body');
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading inventory data</td></tr>';
            });
    }
    
    // Function to load agent logs
    function loadAgentLogs() {
        fetch('/api/logs?limit=5')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('agent-logs-body');
                    
                    // Clear table
                    tableBody.innerHTML = '';
                    
                    if (data.logs.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No agent logs available</td></tr>';
                        return;
                    }
                    
                    // Add rows
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const timestamp = new Date(log.timestamp);
                        const formattedDate = timestamp.toLocaleString();
                        
                        // Format agent type
                        let agentClass = '';
                        switch (log.agent_type) {
                            case 'demand':
                                agentClass = 'text-primary';
                                break;
                            case 'inventory':
                                agentClass = 'text-success';
                                break;
                            case 'pricing':
                                agentClass = 'text-warning';
                                break;
                        }
                        
                        // Format details
                        let details = '';
                        if (log.details) {
                            try {
                                const detailsObj = JSON.parse(log.details);
                                details = Object.entries(detailsObj)
                                    .filter(([key]) => key !== 'product_name' && key !== 'store_name')
                                    .map(([key, value]) => `${key}: ${value}`)
                                    .join(', ');
                            } catch (e) {
                                details = log.details;
                            }
                        }
                        
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td class="${agentClass}">${log.agent_type.charAt(0).toUpperCase() + log.agent_type.slice(1)} Agent</td>
                            <td>${log.action}</td>
                            <td>${log.product_name || '-'}</td>
                            <td>${log.store_name || '-'}</td>
                            <td>${details}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
                const tableBody = document.getElementById('agent-logs-body');
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading agent logs</td></tr>';
            });
    }
    
    // Create category chart
    function createCategoryChart(inventoryData) {
        const ctx = document.getElementById('category-chart').getContext('2d');
        
        // Group data by category
        const categoryMap = {};
        
        inventoryData.forEach(item => {
            const category = getProductCategory(item.product_id);
            if (!categoryMap[category]) {
                categoryMap[category] = 0;
            }
            categoryMap[category] += item.quantity;
        });
        
        // Prepare chart data
        const categories = Object.keys(categoryMap);
        const quantities = Object.values(categoryMap);
        
        // Destroy previous chart if it exists
        if (categoryChart) {
            categoryChart.destroy();
        }
        
        // Create new chart
        categoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: categories,
                datasets: [{
                    data: quantities,
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Inventory by Product Category'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} units (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Create store chart
    function createStoreChart(inventoryData) {
        const ctx = document.getElementById('store-chart').getContext('2d');
        
        // Group data by store
        const storeMap = {};
        
        inventoryData.forEach(item => {
            if (!storeMap[item.store_name]) {
                storeMap[item.store_name] = 0;
            }
            storeMap[item.store_name] += item.quantity;
        });
        
        // Prepare chart data
        const stores = Object.keys(storeMap);
        const quantities = Object.values(storeMap);
        
        // Destroy previous chart if it exists
        if (storeChart) {
            storeChart.destroy();
        }
        
        // Create new chart
        storeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: stores,
                datasets: [{
                    label: 'Total Inventory',
                    data: quantities,
                    backgroundColor: 'rgba(255, 193, 7, 0.7)',
                    borderColor: 'rgba(255, 193, 7, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Inventory by Store Location'
                    }
                }
            }
        });
    }
    
    // Helper function to get product category
    function getProductCategory(productId) {
        // This is a simple implementation - in a real application, you'd fetch this from the server
        // or maintain a local cache of product data
        const productCategories = {
            1: 'Electronics',
            2: 'Electronics',
            3: 'Electronics',
            4: 'Clothing',
            5: 'Clothing'
        };
        
        return productCategories[productId] || 'Unknown';
    }
});
</script>
{% endblock %}
