{% extends "base.html" %}

{% block title %}Home - AI Inventory Optimization{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">AI Inventory Optimization System</h2>
                <p class="card-text">
                    Welcome to the AI Inventory Optimization System, powered by a multi-agent
                    architecture designed to optimize your inventory management processes.
                </p>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Demand Forecasting</h5>
                                <p class="card-text">Predict future product demand using AI-powered analytics.</p>
                                <a href="/dashboard" class="btn btn-primary">View Forecasts</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Inventory Optimization</h5>
                                <p class="card-text">Get recommendations for optimal inventory levels.</p>
                                <a href="/dashboard" class="btn btn-primary">View Recommendations</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Pricing Strategies</h5>
                                <p class="card-text">Optimize pricing based on demand and market data.</p>
                                <a href="/dashboard" class="btn btn-primary">View Prices</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Generate Predictions</h3>
                <p class="card-text">Select a product and store to generate demand forecasts, inventory recommendations, and pricing strategies.</p>
                
                <form id="predictionForm" class="mt-3">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="productSelect" class="form-label">Product</label>
                            <select class="form-select" id="productSelect" required>
                                <option value="" selected disabled>Select Product</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} ({{ product.category }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="storeSelect" class="form-label">Store</label>
                            <select class="form-select" id="storeSelect" required>
                                <option value="" selected disabled>Select Store</option>
                                {% for store in stores %}
                                <option value="{{ store.id }}">{{ store.name }} ({{ store.location }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="daysInput" class="form-label">Days to Forecast</label>
                            <input type="number" class="form-control" id="daysInput" value="30" min="1" max="90" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Predictions</button>
                </form>
                
                <div id="predictionResults" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Processing prediction... Please wait.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const predictionForm = document.getElementById('predictionForm');
    const predictionResults = document.getElementById('predictionResults');
    
    predictionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading indicator
        predictionResults.style.display = 'block';
        
        // Get form values
        const productId = document.getElementById('productSelect').value;
        const storeId = document.getElementById('storeSelect').value;
        const days = document.getElementById('daysInput').value;
        
        // Make API request
        fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: parseInt(productId),
                store_id: parseInt(storeId),
                days: parseInt(days)
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Process results and update UI
            if (data.success) {
                // Format the results in a user-friendly way
                let resultsHTML = `
                    <h4 class="mt-4">Prediction Results</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">Demand Forecast</h5>
                                </div>
                                <div class="card-body">
                                    <p>Average predicted daily demand: <strong>${(data.predictions.reduce((sum, p) => sum + p.demand, 0) / data.predictions.length).toFixed(2)}</strong></p>
                                    <p>Forecast period: <strong>${days} days</strong></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">Inventory Recommendation</h5>
                                </div>
                                <div class="card-body">
                                    <p>Status: <strong>${data.inventory_recommendation.status}</strong></p>
                                    <p>Current quantity: <strong>${data.inventory_recommendation.current_quantity}</strong></p>
                                    <p>Recommended order: <strong>${data.inventory_recommendation.recommended_order}</strong></p>
                                    <p><em>${data.inventory_recommendation.reasoning}</em></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="card-title mb-0">Pricing Recommendation</h5>
                                </div>
                                <div class="card-body">
                                    <p>Strategy: <strong>${data.pricing_recommendation.strategy}</strong></p>
                                    <p>Base price: <strong>$${data.pricing_recommendation.base_price.toFixed(2)}</strong></p>
                                    <p>Recommended price: <strong>$${data.pricing_recommendation.recommended_price.toFixed(2)}</strong></p>
                                    <p><em>${data.pricing_recommendation.explanation}</em></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4">Demand Forecast Chart</h4>
                    <canvas id="demandChart" width="400" height="200"></canvas>
                `;
                
                predictionResults.innerHTML = resultsHTML;
                
                // Create chart
                const dates = data.predictions.map(p => p.date);
                const demands = data.predictions.map(p => p.demand);
                
                new Chart(document.getElementById('demandChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Predicted Demand',
                            data: demands,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Demand'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } else {
                // Show error
                predictionResults.innerHTML = `
                    <div class="alert alert-danger">
                        Error generating predictions: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            predictionResults.innerHTML = `
                <div class="alert alert-danger">
                    Error connecting to the server. Please try again.
                </div>
            `;
        });
    });
});
</script>
{% endblock %}