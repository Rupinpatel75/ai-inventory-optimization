{% extends "base.html" %}

{% block title %}AI Inventory Optimization System - Home{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">AI-Powered Inventory Optimization System</h2>
                <p class="card-text">
                    This platform leverages advanced multi-agent architecture to deliver intelligent 
                    inventory management solutions through:
                </p>
                <div class="row justify-content-center text-center mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 bg-dark border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">Demand Forecasting</h5>
                                <p class="card-text">
                                    AI-powered prediction of future demand based on historical data, 
                                    seasonality, and market trends.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 bg-dark border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">Inventory Management</h5>
                                <p class="card-text">
                                    Automated inventory optimization to minimize holding costs while 
                                    preventing stockouts.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 bg-dark border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info">Pricing Strategies</h5>
                                <p class="card-text">
                                    Dynamic pricing recommendations based on demand elasticity, 
                                    competition, and inventory levels.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h3>Generate Optimization Insights</h3>
            </div>
            <div class="card-body">
                <form id="prediction-form" class="mb-4">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="product-select" class="form-label">Product</label>
                            <select class="form-select" id="product-select" required>
                                <option value="" selected disabled>Select a product</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} ({{ product.category }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="store-select" class="form-label">Store</label>
                            <select class="form-select" id="store-select" required>
                                <option value="" selected disabled>Select a store</option>
                                {% for store in stores %}
                                <option value="{{ store.id }}">{{ store.name }} ({{ store.location }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="days-input" class="form-label">Forecast Days</label>
                            <input type="number" class="form-control" id="days-input" min="7" max="90" value="30" required>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Generate Insights</button>
                    </div>
                </form>

                <div id="loading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing data and generating insights...</p>
                </div>

                <div id="results-container" class="d-none">
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card bg-dark border-info">
                                <div class="card-header bg-dark">
                                    <h4>Demand Forecast</h4>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="demand-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card bg-dark border-info h-100">
                                <div class="card-header bg-dark">
                                    <h4>Inventory Recommendation</h4>
                                </div>
                                <div class="card-body" id="inventory-recommendation">
                                    <!-- Inventory recommendation will be inserted here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card bg-dark border-info h-100">
                                <div class="card-header bg-dark">
                                    <h4>Pricing Recommendation</h4>
                                </div>
                                <div class="card-body" id="pricing-recommendation">
                                    <!-- Pricing recommendation will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="error-message" class="alert alert-danger d-none" role="alert">
                    <!-- Error messages will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables for charts
    let demandChart = null;
    
    // Check LLM status on page load
    checkLLMStatus();
    
    // Form submission
    const form = document.getElementById('prediction-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        generatePredictions();
    });
    
    // Function to generate predictions
    function generatePredictions() {
        const productId = document.getElementById('product-select').value;
        const storeId = document.getElementById('store-select').value;
        const days = document.getElementById('days-input').value;
        
        // Show loading indicator
        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('results-container').classList.add('d-none');
        document.getElementById('error-message').classList.add('d-none');
        
        // Make API call
        fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: parseInt(productId),
                store_id: parseInt(storeId),
                days: parseInt(days)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data);
            } else {
                showError(data.error || 'An error occurred generating predictions.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred. Please try again.');
        })
        .finally(() => {
            document.getElementById('loading').classList.add('d-none');
        });
    }
    
    // Function to display results
    function displayResults(data) {
        // Show results container
        document.getElementById('results-container').classList.remove('d-none');
        
        // Demand chart
        displayDemandChart(data.predictions);
        
        // Inventory recommendation
        displayInventoryRecommendation(data.inventory_recommendation);
        
        // Pricing recommendation
        displayPricingRecommendation(data.pricing_recommendation);
    }
    
    // Function to display demand chart
    function displayDemandChart(predictions) {
        const ctx = document.getElementById('demand-chart').getContext('2d');
        
        // Extract dates and demand values
        const dates = predictions.map(p => p.date);
        const demand = predictions.map(p => p.demand);
        
        // Destroy existing chart if it exists
        if (demandChart) {
            demandChart.destroy();
        }
        
        // Create new chart
        demandChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Predicted Demand',
                    data: demand,
                    borderColor: '#0dcaf0',
                    backgroundColor: 'rgba(13, 202, 240, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Demand Forecast'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }
    
    // Function to display inventory recommendation
    function displayInventoryRecommendation(recommendation) {
        const container = document.getElementById('inventory-recommendation');
        
        // Clear previous content
        container.innerHTML = '';
        
        if (!recommendation) {
            container.innerHTML = '<div class="alert alert-warning">No inventory recommendation available.</div>';
            return;
        }
        
        // Create HTML content
        let html = `
            <div class="mb-3">
                <h5 class="text-primary">Reorder Recommendation</h5>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Reorder Quantity:</span>
                    <span class="badge bg-primary">${recommendation.reorder_quantity} units</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Order Timing:</span>
                    <span class="badge ${getTimingBadgeClass(recommendation.reorder_timing)}">${recommendation.reorder_timing}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Stockout Risk:</span>
                    <span class="badge ${getRiskBadgeClass(recommendation.risk_assessment)}">${recommendation.risk_assessment}</span>
                </div>
            </div>
            
            <div class="mb-3">
                <h5 class="text-primary">Current Inventory Status</h5>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Current Stock:</span>
                    <span class="badge bg-secondary">${recommendation.current_stock} units</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Days Until Stockout:</span>
                    <span class="badge bg-secondary">${recommendation.days_until_stockout} days</span>
                </div>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar ${getStockLevelClass(recommendation.stock_level_percentage)}" 
                        role="progressbar" 
                        style="width: ${recommendation.stock_level_percentage}%;" 
                        aria-valuenow="${recommendation.stock_level_percentage}" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                        ${Math.round(recommendation.stock_level_percentage)}%
                    </div>
                </div>
            </div>
            
            <div>
                <h5 class="text-primary">Explanation</h5>
                <p>${recommendation.explanation}</p>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // Function to display pricing recommendation
    function displayPricingRecommendation(recommendation) {
        const container = document.getElementById('pricing-recommendation');
        
        // Clear previous content
        container.innerHTML = '';
        
        if (!recommendation) {
            container.innerHTML = '<div class="alert alert-warning">No pricing recommendation available.</div>';
            return;
        }
        
        // Create HTML content
        let html = `
            <div class="mb-3">
                <h5 class="text-primary">Price Recommendation</h5>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Current Price:</span>
                    <span class="badge bg-secondary">$${recommendation.current_price.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Recommended Price:</span>
                    <span class="badge bg-primary">$${recommendation.recommended_price.toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Price Change:</span>
                    <span class="badge ${getPriceChangeBadgeClass(recommendation.price_change_percentage)}">${recommendation.price_change_percentage > 0 ? '+' : ''}${recommendation.price_change_percentage.toFixed(1)}%</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Strategy:</span>
                    <span class="badge ${getStrategyBadgeClass(recommendation.strategy)}">${recommendation.strategy}</span>
                </div>
            </div>
            
            <div class="mb-3">
                <h5 class="text-primary">Expected Impact</h5>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Revenue Change:</span>
                    <span class="badge ${getImpactBadgeClass(recommendation.expected_impact.revenue_change_pct)}">${recommendation.expected_impact.revenue_change_pct > 0 ? '+' : ''}${recommendation.expected_impact.revenue_change_pct.toFixed(1)}%</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Demand Change:</span>
                    <span class="badge ${getImpactBadgeClass(recommendation.expected_impact.demand_change_pct)}">${recommendation.expected_impact.demand_change_pct > 0 ? '+' : ''}${recommendation.expected_impact.demand_change_pct.toFixed(1)}%</span>
                </div>
            </div>
            
            <div>
                <h5 class="text-primary">Explanation</h5>
                <p>${recommendation.explanation}</p>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // Helper functions for styling
    function getTimingBadgeClass(timing) {
        switch(timing) {
            case 'NOW': return 'bg-danger';
            case 'SOON': return 'bg-warning';
            case 'LATER': return 'bg-success';
            default: return 'bg-secondary';
        }
    }
    
    function getRiskBadgeClass(risk) {
        switch(risk) {
            case 'HIGH': return 'bg-danger';
            case 'MEDIUM': return 'bg-warning';
            case 'LOW': return 'bg-success';
            default: return 'bg-secondary';
        }
    }
    
    function getStockLevelClass(percentage) {
        if (percentage < 25) return 'bg-danger';
        if (percentage < 50) return 'bg-warning';
        return 'bg-success';
    }
    
    function getPriceChangeBadgeClass(percentage) {
        if (percentage > 10) return 'bg-success';
        if (percentage < -10) return 'bg-danger';
        if (percentage > 0) return 'bg-info';
        if (percentage < 0) return 'bg-warning';
        return 'bg-secondary';
    }
    
    function getStrategyBadgeClass(strategy) {
        switch(strategy) {
            case 'PREMIUM': return 'bg-primary';
            case 'INCREASE': return 'bg-success';
            case 'MAINTAIN': return 'bg-secondary';
            case 'DISCOUNT': return 'bg-warning';
            case 'CLEARANCE': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    function getImpactBadgeClass(percentage) {
        if (percentage > 10) return 'bg-success';
        if (percentage < -10) return 'bg-danger';
        if (percentage > 0) return 'bg-info';
        if (percentage < 0) return 'bg-warning';
        return 'bg-secondary';
    }
    
    // Function to show error message
    function showError(message) {
        const errorContainer = document.getElementById('error-message');
        errorContainer.textContent = message;
        errorContainer.classList.remove('d-none');
    }
});
</script>
{% endblock %}
