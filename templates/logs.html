{% extends "base.html" %}

{% block title %}Agent Logs - AI Inventory Optimization{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">Agent Activity Logs</h2>
                <p class="card-text">View a history of actions taken by the AI agents in the system.</p>
                
                <div class="row mt-4">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Agent Action Distribution</h5>
                                <div>
                                    <select id="chartTimeFrame" class="form-select form-select-sm">
                                        <option value="7">Last 7 days</option>
                                        <option value="30" selected>Last 30 days</option>
                                        <option value="90">Last 90 days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="agentActivityChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Detailed Logs</h5>
                                <div class="d-flex">
                                    <select id="agentTypeFilter" class="form-select form-select-sm me-2">
                                        <option value="">All Agents</option>
                                        <option value="demand">Demand Agent</option>
                                        <option value="inventory">Inventory Agent</option>
                                        <option value="pricing">Pricing Agent</option>
                                    </select>
                                    <select id="limitFilter" class="form-select form-select-sm">
                                        <option value="20">20 entries</option>
                                        <option value="50">50 entries</option>
                                        <option value="100">100 entries</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Agent Type</th>
                                                <th>Action</th>
                                                <th>Product</th>
                                                <th>Store</th>
                                                <th>Details</th>
                                                <th>Timestamp</th>
                                            </tr>
                                        </thead>
                                        <tbody id="logsTable">
                                            <tr>
                                                <td colspan="6" class="text-center">
                                                    <div class="spinner-border" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agentTypeFilter = document.getElementById('agentTypeFilter');
    const limitFilter = document.getElementById('limitFilter');
    const chartTimeFrame = document.getElementById('chartTimeFrame');
    let agentActivityChart;
    
    // Initial logs load
    loadLogs();
    
    // Event listeners for filters
    agentTypeFilter.addEventListener('change', loadLogs);
    limitFilter.addEventListener('change', loadLogs);
    chartTimeFrame.addEventListener('change', updateActivityChart);
    
    // Load logs based on filters
    function loadLogs() {
        const agentType = agentTypeFilter.value;
        const limit = limitFilter.value;
        const logsTable = document.getElementById('logsTable');
        
        // Show loading
        logsTable.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        `;
        
        // Build query params
        let params = new URLSearchParams();
        if (agentType) params.append('agent_type', agentType);
        params.append('limit', limit);
        
        // Fetch logs
        fetch(`/api/logs?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const logs = data.logs;
                    
                    // Update table
                    if (logs.length === 0) {
                        logsTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">No logs found</td>
                            </tr>
                        `;
                    } else {
                        let tableHTML = '';
                        logs.forEach(log => {
                            // Parse details if it's a JSON string
                            let details = log.details || '';
                            try {
                                if (details) {
                                    const parsedDetails = JSON.parse(details);
                                    details = Object.entries(parsedDetails)
                                        .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                                        .join('<br>');
                                }
                            } catch (e) {
                                // If not valid JSON, use as-is
                            }
                            
                            // Format log entry
                            tableHTML += `
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-${getAgentColor(log.agent_type)}">
                                            ${capitalize(log.agent_type)}
                                        </span>
                                    </td>
                                    <td>${log.action}</td>
                                    <td>${log.product_name || 'N/A'}</td>
                                    <td>${log.store_name || 'N/A'}</td>
                                    <td>${details}</td>
                                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                                </tr>
                            `;
                        });
                        logsTable.innerHTML = tableHTML;
                    }
                    
                    // Get all logs for chart
                    updateActivityChart();
                } else {
                    console.error('Error fetching logs');
                    logsTable.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger">Error loading logs</td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                logsTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">Error connecting to the server</td>
                    </tr>
                `;
            });
    }
    
    // Update activity chart
    function updateActivityChart() {
        // Get days for time frame
        const days = parseInt(chartTimeFrame.value);
        
        // Fetch all logs for charting
        fetch(`/api/logs?limit=1000`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const logs = data.logs;
                    
                    // Process logs for chart
                    const agentCounts = {
                        'demand': 0,
                        'inventory': 0,
                        'pricing': 0
                    };
                    
                    // Calculate cutoff date
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    
                    // Count recent actions by agent type
                    logs.forEach(log => {
                        const logDate = new Date(log.timestamp);
                        if (logDate >= cutoffDate) {
                            agentCounts[log.agent_type] = (agentCounts[log.agent_type] || 0) + 1;
                        }
                    });
                    
                    // Create or update chart
                    const ctx = document.getElementById('agentActivityChart').getContext('2d');
                    
                    const chartData = {
                        labels: ['Demand Agent', 'Inventory Agent', 'Pricing Agent'],
                        datasets: [{
                            label: 'Number of Actions',
                            data: [
                                agentCounts['demand'],
                                agentCounts['inventory'],
                                agentCounts['pricing']
                            ],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    };
                    
                    // Destroy previous chart if exists
                    if (agentActivityChart) {
                        agentActivityChart.destroy();
                    }
                    
                    // Create new chart
                    agentActivityChart = new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Number of Actions'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Agent Activity (Last ${days} Days)`
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // Helper functions
    function getAgentColor(agentType) {
        switch (agentType) {
            case 'demand': return 'primary';
            case 'inventory': return 'success';
            case 'pricing': return 'warning';
            default: return 'secondary';
        }
    }
    
    function capitalize(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
});
</script>
{% endblock %}